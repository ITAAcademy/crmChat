"use strict";springChatControllers.config(["$routeProvider",function(e){e.when("/builder",{templateUrl:"builderTemplateJSTemp.html",controller:"ChatBotViewBuilderController"}),e.when("/builderForm",{templateUrl:"builderTemplateJSTemp.html",controller:"ChatBotFormBuilderController"}),e.when("/dialog_view/:roomId/",{resolve:{load:["$route","RoomsFactory","ChannelFactory","$routeParams",function(e,o,t,n){t.getIsInited()&&o.goToRoom(e.current.params.roomId)}]}}),e.when("/access_deny",{templateUrl:"accessDeny.html",controller:"AccessDeny"}),e.when("/private_dialog_view/:chatUserId",{resolve:{load:["$route","RoomsFactory","$routeParams",function(e,o,t){o.goToPrivateDialog(e.current.params.chatUserId)}]}}),e.otherwise({redirectTo:"/"}),console.log("scope test")}]);var chatControllerScope;springChatControllers.controller("AccessDeny",["$locationProvider","$routeParams","$rootScope","$scope","$http","$location","$interval","$cookies","$timeout","toaster","$cookieStore",function(e,o,t,n,r,s,a,l,i,c,u){}]);var chatController=springChatControllers.controller("ChatController",["$sce","ngDialog","$q","$rootScope","$scope","$http","$route","$location","$interval","$cookies","$timeout","toaster","$cookieStore","RoomsFactory","UserFactory","ChannelFactory",function(e,o,t,n,r,s,a,l,i,c,u,d,g,m,h,f){function p(e,o){this.avatar=e,this.name=o}function v(e){var o=globalConfig.baseUrl;return o+"/profile/"+e+"/"}function w(e,o){var t=globalConfig.baseUrl;return t+"/course/"+o+"/"+e+"/"}function I(e,o){if(null!=o){for(var t=Object.keys(o),a=0;a<m.getRooms().length;a++){var l=m.getRooms()[a],i=$.inArray(""+l.roomId,t);if(i!=-1&&(n.roomForUpdate[l.roomId]=!0,l.lastMessage=o[l.roomId],l.lastMessageDate=(new Date).getTime(),void 0==m.getCurrentRoom()||m.getCurrentRoom().roomId!=l.roomId)){l.nums++,m.updateNewMsgNumber(1),r.soundEnable&&new Audio("data/new_mess.mp3").play(),d.pop("note","NewMessage in "+l.string,"",2e3);break}}var c=null;void 0!=m.getCurrentRoom()&&""==m.getCurrentRoom().roomId&&void 0!=n.roomForUpdate.keys().next()&&(null!=c&&c.cancel(),c=u(function(){s.post(serverPrefix+"/chat/update/dialog_list",{roomForUpdate:n.roomForUpdate}),n.roomForUpdate=new Map,c=null},2500))}}function b(){d.pop("error","Error","server request timeout",0)}function y(){var e=$("#messagesScroll");e.scrollTop();E="undefined"==typeof e||"undefined"==typeof e[0]?void 0:e[0].scrollHeight-e.scrollTop()-e[0].clientHeight,console.log("savedDistanceToBottom:"+E)}function C(e){var o=$("#messagesScroll"),t=o[0].clientHeight,n=t-e;if(n<0)return o.scrollTop();var r=o[0].scrollHeight+n;if(console.log("heightDelta:"+n),console.log("savedPaddingHeight:"+P),console.log("scrollHeight:"+r),"undefined"!=typeof E){var s=r-E-o[0].clientHeight;return console.log("scrollTop:"+s),s}}function _(e){var o=$(".right_panel").height(),t=$(".tools_area").height(),n=$(".messages_input_area").height(),r=o-t-n-10;n>r||(y(),$("#messagesScroll").stop(!0).animate({height:r,scrollTop:C(r)},1e3))}f.setIsInited(!1),n.baseurl=globalConfig.baseUrl,n.imagesPath=globalConfig.imagesPath,r.baseurl=globalConfig.baseUrl,n.firstLetter=firstLetter,n.checkIfToday=checkIfToday,n.checkIfYesterday=checkIfYesterday,n.needShowDayDivided=function(e,o){return!(!checkIfToday(e)&&!checkIfYesterday(e))||isSameDay(e,o)},n.getNameFromUrl=getNameFromUrl,n.getNameFromRandomizedUrl=getNameFromRandomizedUrl,r.state=2,r.loadOnlyFilesInfiniteScrollMode=!1,r.toggleAskForDeleteMeFromCurrentRoom=function(){S(m.getCurrentRoom())},r.mouseMoveEvent=function(e){1==e.buttons},r.dragOptions={start:function(e){console.log("STARTING")},drag:function(e){console.log("DRAGGING")},stop:function(e){console.log("STOPPING")},container:"body",dragElement:"consultant_wrapper"},r.newMessage="";var T=angular.element(document.getElementById("panel-body"));r.resizeRoomElement=function(e,o){T.css("height","calc(100% - "+o+"px)")},r.getStateClass=function(){switch(r.state){case 0:return $(".consultant_wrapper").removeClass("drag-disable"),"normal";case 1:return $(".consultant_wrapper").removeClass("drag-disable"),"minimize";case 2:return $(".consultant_wrapper").removeAttr("style"),$(".consultant_wrapper").addClass("drag-disable"),"fullScreen";case-1:return"closed"}},n.goToUserPage=function(e){var o=s({method:"get",url:serverPrefix+"/get_id_by_username?intitaUsername="+e,data:null,headers:{"Content-Type":"application/x-www-form-urlencoded"}});return o.success(function(e){if(null!=e)return window.open(v(e),"_blank"),!0}),!1},r.$on("$routeChangeStart",m.unsubscribeCurrentRoom),r.isUserTenant=!1,r.isUserTenantInited=!1,r.blocksNames=["first","second"],r.blocksItems=[[new p("","Людмила Журавская")],[new p("","Василій Пупкін",!0),new p("","Микола Петряк")]],r.clickSetTenantFree=function(){h.setTenantFree(!0),s.post(serverPrefix+"/bot_operations/tenant/becomeFree")},r.clickSetTenantBusy=function(){h.setTenantBusy(),s.post(serverPrefix+"/bot_operations/tenant/becomeBusy")},r.answerToFinishConsultation=function(){s.post(serverPrefix+"/bot_operations/tenant/becomeFree")},r.needReloadPage=!0;var S=function(e){void 0!=e&&null!=e&&(n.askForDeleteMe={room:e,isAuthor:h.getChatUserId()==e.roomAuthorId}),o.open({template:"askForDeleteMe.html",scope:r})};r.deleteMeFromRoom=function(){var e=function(){n.askForDeleteMe.error="Не вдалося видалити Вас з розмови!!!"};s.post(serverPrefix+"/chat/rooms/{0}/remove".format(n.askForDeleteMe.room.roomId)).success(function(t,n,r,s){1==t?o.closeAll():e()}).error(function(o,t,n,r){e()})},r.toggleNewRoomModal=function(){$("#new_room_modal").modal("toggle"),u.cancel(r.setFocusToRoomNameInput),R=!R,r.setFocusToRoomNameInput=u(function(){1==R&&$("#roomNameInput").focus()},300)};var R=!1;n.formatDateWithLast=formatDateWithLast,n.formatDate=formatDate,n.goToCourseByTitle=function(e,o){var t=s({method:"get",url:serverPrefix+"/get_course_alias_by_title?title="+encodeURIComponent(e)+"&lang="+encodeURIComponent(o),data:null,headers:{"Content-Type":"application/x-www-form-urlencoded"}});t.success(function(e){if(null!=e)return window.open(w(e,o),"_blank"),!0})},n.parseMsg=function(e){return null==e?null:(e=r.parseMain(e,"\\B@\\w+@\\w+[.]\\w+","goToUserPage(#)",1),e=r.parseMain(e,'\\B~["].+["]',"goToCourseByTitle(#,&quot;ua&quot;)",2,3))},n.parseMain=function(e,o,t,n,r){if(null==e)return null;n=n||0,r=r||0;var s=new RegExp(o,"g");return e=e.replace(s,function(e){return' <a ng-click="'+t.replace(new RegExp("#","g"),"'"+e.substr(n,e.length-r).escapeHtml()+"'")+'">'+e.substr(n,e.length-r)+"</a>"})},r.changeLocation=function(e){d.clear(),l.path(e),console.log("Change location:"+l.path())};var M=r.changeLocation;n.socketSupport=!0,n.authorize=!1,r.disableAddDlgButton=!1,n.$watch("authorize",function(){r.disableAddDlgButton=!n.authorize}),n.roomForUpdate=new Map,n.redirectzToAuthorizePage=function(){window.top.location.href=globalConfig.baseUrl+"/site/authorize"},n.goToAuthorize=function(e){};t.defer();String.prototype.format||(String.prototype.format=function(){var e=arguments;return this.replace(/{(\d+)}/g,function(o,t){return"undefined"!=typeof e[t]?e[t]:o})}),r.emails=[],r.show_search_list_admin=!1;var U;r.searchInputValue={email:""},r.hideSearchList=function(){r.show_search_list=!1,r.show_search_list_admin=!1},r.onFriendClick=function(e){void 0!=e.chatUserId&&null!=e.chatUserId?window.location.replace(serverPrefix+"/chat/go/rooms/private/"+e.chatUserId+"?isChatId=true"):window.location.replace(serverPrefix+"/chat/go/rooms/private/"+e.id+"?isChatId=false")},n.getUserSearchIndetify=function(e,o){if(void 0==e||""==e)return"";var t="";return null!=e.firstName&&(t+=e.firstName+" "),null!=e.secondName&&(t+=e.secondName),null!=o&&null!=e.email&&e.email.indexOf(o)!=-1||null==t||" "==t?e.email:t},r.showSearchList=function(e){r.show_search_list=!0,r.emails=[],u.cancel(U);var o;o=1==e?serverPrefix+"/get_users_like?login="+r.searchInputValue.email:serverPrefix+"/get_users_like?login="+r.searchInputValue.email+"&room="+m.getCurrentRoom().roomId+"&eliminate_users_of_current_room=true",U=u(function(){r.show_search_list=!0;var e=s({method:"get",url:o,data:null,headers:{"Content-Type":"application/x-www-form-urlencoded"}});e.success(function(e){r.emails=e})},500)},r.appendToSearchInput=function(e){console.log("searchInputValue:"+r.searchInputValue.email),r.searchInputValue.email=e,r.show_search_list=!1},r.showSearchListAdmin=function(){r.emails=[],u.cancel(U),U=u(function(){var e=s({method:"get",url:serverPrefix+"/get_users_nicknames_like_without_room?nickName="+r.searchResultAdmin,data:null,headers:{"Content-Type":"application/x-www-form-urlencoded"}});e.success(function(e){r.show_search_list_admin=!0,r.emails=e})},500)},r.returnToRealUser=function(){r.changeUser(r.realChatUserId,r.realChatUserId),n.isMyRoom=!0},r.changeUser=function(e,o){r.emails=[],r.chatUserId=e,r.chatUserNickname=o,r.searchResultAdmin="";var t=r.chatUserRole;n.socketSupport?f.initForWS(!0):f.reInitForLP(),u(function(){r.chatUserRole=t},2e3),n.isMyRoom=!1},r.searchUserName="",r.chatUserId=-1,r.realChatUserId=-1,r.chatUserRole=0,r.chatUserNickname="",r.sendTo="everyone",r.dialogShow=!1,r.roomAdded=!0,r.showDialogListButton=!1,r.searchResultAdmin,n.isMyRoom=!0,r.userAddedToRoom=!0,n.isConectedWithFreeTenant=!1;var F=!1;n.showToasterWaitFreeTenant=function(){F&&(d.pop({type:"wait",body:"Wait for free consultant",timeout:0,onHideCallback:function(){n.isConectedWithFreeTenant||n.authorize||(F=!1,n.showToasterWaitFreeTenant())},showCloseButton:!1}),F=!0)},n.message_busy=!1,n.loadOtherMessages=function(){if(!n.message_busy&&null!=m.getCurrentRoom()){var e="/{0}/chat/loadOtherMessage";r.loadOnlyFilesInfiniteScrollMode&&(e="/{0}/chat/loadOtherMessageWithFiles"),n.message_busy=!0,console.log("TRY "+r.messages.length);var o=null==m.getOldMessage()?null:m.getOldMessage().date,t={date:o};r.messageSearchEnabled&&(t.searchQuery=r.messageSearchQuery.value),s.post(serverPrefix+e.format(m.getCurrentRoom().roomId),t).success(function(e,o,t,s){console.log("MESSAGE onLOAD OK "+e);var a=document.getElementById("messagesScroll"),l=a.scrollHeight;if(""!=e){for(var i=0;i<e.length;i++)e[i].hasOwnProperty("message")&&m.calcPositionUnshift(e[i]);r.$$postDigest(function(){var e=document.getElementById("messagesScroll");e.scrollTop=e.scrollHeight-l,n.message_busy=!1,r.$apply()})}}).error(function(e,o,t,n){console.log("TEST"),"404"!=o&&"405"!=o||chatControllerScope.changeLocation("/")})}},n.$on("MessageAreaScrollDownEvent",function(){var e=document.getElementById("messagesScroll");e.scrollTop=99999999999}),n.$on("MessageBusyEvent",function(e,o){n.message_busy=o}),n.checkPrivateRelations=function(e,o){if(null!=e)return 1==e.type&&void 0!=e.privateUserIds&&(e.privateUserIds[0]==o.chatUserId||e.privateUserIds[1]==o.chatUserId)},n.$on("newMessageEvent",I),r.getKeys=function(e){for(var o=Object.keys(e),t=0;t<o.length;t++){var n=void 0;void 0!=e[o[t]]&&(n=e[o[t]]),console.log(t+") "+o[t]+" = "+n)}},r.getLength=function(e){return Object.keys(e).length},n.messageError=b,n.submitConsultation_processUser=function(e){e==m.getCurrentRoom().roomId&&(n.isConectedWithFreeTenant=!0,d.clear(),n.isConectedWithFreeTenant=!1)},n.submitConsultation_processTenant=function(e,o){e==h.getChatUserId()&&u(function(){f.changeLocation("/dialog_view/"+o)},100)},r.messageSearchEnabled=!1,r.enableMessagesSearch=function(e){e.stopPropagation(),e.preventDefault(),r.messageSearchQuery={value:""},r.messageSearchEnabled=!0,setTimeout(function(){$("#searchInput").focus()},500)},r.showMenu=!1,r.toggleMenu=function(){r.showMenu=!r.showMenu},n.hideMenu=function(){r.showMenu=!1},r.getNewMsgNumber=m.getNewMsgNumber;var k;r.updateMessagesSearch=function(){void 0!=k&&u.cancel(k),k=u(function(){m.clearMessages(),m.loadMessagesContains(r.messageSearchQuery.value),n.message_busy=!1;var e=document.getElementById("messagesScroll");e.scrollTop=99999999999},500)},r.focusMessagesSearchChange=function(){""==r.messageSearchQuery.value&&r.disableMessagesSearch(!1)},n.$on("RoomChanged",function(e,o){r.disableMessagesSearch()}),r.disableMessagesSearch=function(e){e===!0&&(m.clearMessages(),m.loadMessagesContains(""),u(function(){n.message_busy=!1},500)),r.messageSearchEnabled=!1;var o=document.getElementById("messagesScroll");null!=o&&(o.scrollTop=99999999999)},r.isMessageInputAvailable=m.checkMessageAdditionPermission,r.currentRoomIsNull=function(){return null==m.getCurrentRoom()||null==m.getCurrentRoom().roomId},r.getCurrentRoom=m.getCurrentRoom,r.$on("$routeChangeStart",r.disableMessagesSearch(!1));var E,P;n.stripHtml=function(e){var o=document.createElement("DIV");return o.innerHTML=e,o.textContent||o.innerText||""},n.isRoomPrivate=m.isRoomPrivate,r.tools_dropdown_click=function(){$("#tools_dropdown").toggleClass("shown")},r.attaches_dropdown_click=function(){$("#attaches_dropdown").toggleClass("shown")},u(function(){_()},1e3),u(function(){$(".messages_input_area").resize(_),$(window).resize(_)}),r.$$postDigest(function(){void 0==localStorage.getItem("soundEnable")&&(localStorage.setItem("soundEnable",!0),r.soundEnable=!0),r.soundEnable="true"==localStorage.getItem("soundEnable"),r.togleSoundEnable=function(){r.soundEnable=!r.soundEnable,localStorage.setItem("soundEnable",r.soundEnable)},r.showAttaches=function(){m.clearMessages(),r.loadOnlyFilesInfiniteScrollMode=!0,n.loadOtherMessages(),n.message_busy=!1;var e=document.getElementById("messagesScroll");e.scrollTop=99999999999},r.showAllMessages=function(e){e===!0&&(m.clearMessages(),m.loadMessagesContains(""),u(function(){n.message_busy=!1},500)),r.loadOnlyFilesInfiniteScrollMode=!1;var o=document.getElementById("messagesScroll");null!=o&&(o.scrollTop=99999999999)},r.canLeaveCurrentRoom=function(){return null!=m.getCurrentRoom()&&1!=m.getCurrentRoom().type},r.getTenantIsFree=h.getTenantIsFree,r.getRoomsRequiredTrainersLength=h.getRoomsRequiredTrainersLength,r.getRoomsRequiredTrainers=h.getRoomsRequiredTrainers,r.confirmToHelp=function(e){s.post(serverPrefix+"/bot_operations/triner/confirmToHelp/"+e,{}).success(function(o,t,n,r){M("/dialog_view/"+e)}).error(function(e,o,t,n){})}})}]);