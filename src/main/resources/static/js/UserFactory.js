"use strict";springChatServices.factory("UserFactory",["$timeout","$rootScope","$location","$http","toaster","$injector","ChannelFactory","ChatSocket","AskWindow",function(e,o,t,r,n,s,a,i,c){function u(){console.log("initSocketsSubscribes"),i.subscribe("/topic/chat.tenants.remove",function(e){for(var o=JSON.parse(e.body),t=0;t<U.length;t++)if(o.chatUserId==U[t].chatUserId){U.splice(t,1);break}}),i.subscribe("/topic/chat.tenants.add",function(e){for(var o=JSON.parse(e.body),t=!1,r=0;r<U.length;r++)if(o.chatUserId==U[r].chatUserId||z()==o.chatUserId){t=!0;break}t||o.chatUserId==z()||U.push(o)})}function d(t){i.subscribe("/app/chat.login/{0}".format(z()),function(r){var a=JSON.parse(r.body);m(a),0==t&&e(function(){i.subscribe("/topic/chat.login",function(e){var t=JSON.parse(e.body).chatUserId;o.$broadcast("login",t)}),i.subscribe("/topic/chat.logout",function(e){var t=JSON.parse(e.body).username;o.$broadcast("logout",t)}),i.subscribe("/topic/{0}/must/get.room.num/chat.message".format(z()),function(e){console.log("new message in room:"+e.body);var t=JSON.parse(e.body);o.$broadcast("newMessageEvent",t)}),i.subscribe("/topic/users/{0}/status".format(z()),function(o){var t=JSON.parse(o.body);switch(t.type){case Operations.send_message_to_all:case Operations.send_message_to_user:N=!0,t.success||n.pop("error","Error",o.body);break;case Operations.add_user_to_room:userAddedToRoom=!0,t.success||n.pop("error","Error","user wasn't added to room");break;case Operations.add_room:roomAdded=!0,t.success||n.pop("error","Error","room wasn't added");break;case Operations.add_room_on_login:e(function(){changeLocation("dialog_view/"+t.description)},1e3);break;case Operations.add_room_from_tenant:break;case"updateRoom":}}),i.subscribe("/topic/users/{0}/info".format(z()),function(e){var o=JSON.parse(e.body);c.setAskObject(o),c.showAskWindow()}),i.subscribe("/topic/users/{0}/submitConsultation".format(z()),function(e){var t=JSON.parse(e.body);o.sendedRoomId=t[0],o.submitConsultation_processUser(o.sendedRoomId);var r=t[1];o.submitConsultation_processTenant(r,o.sendedRoomId)}),i.subscribe("/app/chat/room.private/room_require_trainer".format(z()),function(e){var o=JSON.parse(e.body);k=o}),i.subscribe("/topic/chat/room.private/room_require_trainer.add".format(z()),function(e){var o=JSON.parse(e.body);for(var t in o)o.hasOwnProperty(t)&&(k[t]=o[t])}),i.subscribe("/topic/chat/room.private/room_require_trainer.remove",function(e){var o=JSON.parse(e.body);delete k[o]}),i.subscribe("/topic/users/info",function(e){var o=s.get("RoomsFactory"),t=JSON.parse(e.body);t.updateRoom.roomId==o.currentRoom.roomId&&(o.currentRoom=t.updateRoom)}),i.subscribe("/user/exchange/amq.direct/errors",function(e){n.pop("error","Error",e.body)})},1500)}),i.subscribe("/topic/chat/rooms/user.{0}".format(z()),function(e){console.log("chatUserId:"+z());var o=s.get("RoomsFactory");o.updateRooms(e)})}function f(){r.post(serverPrefix+"/chat/global/lp/info").success(function(e,t,r,n){if(console.log("infoUpdateLP data:"+e),null!=e.newMessage&&o.$broadcast("newMessageArrayEvent",e.newMessage),null!=e.newAsk_ToChatUserId&&(c.setAskObject(e.newAsk_ToChatUserId[0]),c.showAskWindow()),null!=e.newConsultationWithTenant){var s=e.newConsultationWithTenant[0][0];o.submitConsultation_processUser(s);var a=e.newConsultationWithTenant[0][1];o.submitConsultation_processTenant(a,s)}if(null!=e["tenants.add"])for(var i=e["tenants.add"],u=0;u<i.length;u++)p(i[u]);if(null!=e["tenants.remove"])for(var i=e["tenants.remove"],u=0;u<i.length;u++)l(i[u]);f()}).error(function(e,o,t,r){f()})}function p(e){for(var o=0;o<U.length;o++)if(null!=e&&null!=U[o]&&e.id==U[o].id)return;U.push(e)}function l(e){for(var o=0;o<U.length;o++)null!=e&&null!=U[o]&&e.id==U[o].id&&U.splice(o,1)}function m(e){var r=s.get("RoomsFactory");I=e.chat_id,O=Boolean(e.isTenant),y=Boolean(e.isTrainer),S=Boolean(e.isStudent),S&&w.push(JSON.parse(e.trainer)),console.log("isTenant:"+O+" isTrainer:"+y+" isStudent:"+S),b=e.chat_user_nickname,h=e.chat_user_role,g=e.chat_user_avatar;var i=JSON.parse(e.onlineUsersIdsJson);if(q(i),e.nextWindow==-1)return void n.pop("error","Authentication err","...Try later",{"position-class":"toast-top-full-width"});if(0==a.isSocketSupport()?r.setRooms(JSON.parse(e.chat_rooms).list):(j(),r.setRooms(JSON.parse(e.chat_rooms).list)),U="undefined"==typeof e.tenants?[]:JSON.parse(e.tenants),_="undefined"==typeof e.friends?[]:JSON.parse(e.friends),a.setIsInited(!0),setTimeout(function(){$("body").addClass("loaded")},100),0==e.nextWindow)o.authorize=!0,"/"==t.path()&&a.changeLocation("/chatrooms");else{if(o.authorize=!1,"/"!=t.path())return;a.changeLocation("/dialog_view/"+e.nextWindow)}}o.authorize=!1;var b,h,g,v,h,_,O=!1,y=!1,S=!1,w=[],I=-1,T=!1,U=[],R=[],N=!0,k=new Map,C=function(){return k},J=function(){return null==k?0:Object.keys(k).length},A=function(){return N},x=function(e){N=e},L=!0,W=function(){L=!0},F=function(){L=!1},E=function(){return L},M=function(e){return R.indexOf(e)!=-1},q=function(e){R=e},P=function(){var e=function(e){console.log("onconnect"),B(e.headers["user-name"]),d(!1),G(z()),u()};a.subscribeToConnect(function(t,a){t?e(a):r.post(serverPrefix+"/chat/login/"+z(),{message:"true"}).success(function(e,o,t,r){var n=s.get("RoomsFactory");console.log("LOGIN OK "+e),m(e),n.subscribeRoomsUpdateLP(),f(),G(z())}).error(function(e,t,r,s){o.messageError(),n.pop("error","Authentication err","...Try later",{"position-class":"toast-top-full-width"})})})};o.$on("login",function(e,o){R.push(o)}),o.$on("logout",function(e,o){var t=R.indexOf(o);R.splice(t,1)}),P();var j=function(){0==T&&r.post(serverPrefix+"/bot_operations/tenant/did_am_busy_tenant").success(function(e,o,t,r){O=e[0],e[0]&&(L=!e[1]),T=!0}).error(function(e,o,t,r){alert("did_am_wait_tenant: server error")})},B=function(e){I=e},z=function(){return I},G=function(e){v=e},K=function(e){if(null==e)return"";var o=M(e.chatUserId);return o?"a"+e.username:"b"+e.username};return{setChatUserId:B,getChatUserId:z,setRealChatUserId:G,login:m,getChatUserNickname:function(){return b},getChatuserAvatar:function(){return g},getTenantsList:function(){return U},getStudentTrainerList:function(){return w},isUserOnline:M,setOnlineUsersIds:q,participantsSort:K,setTenantFree:W,setTenantBusy:F,getTenantIsFree:E,isMessageSended:A,setMessageSended:x,getRoomsRequiredTrainers:C,getRoomsRequiredTrainersLength:J}}]);