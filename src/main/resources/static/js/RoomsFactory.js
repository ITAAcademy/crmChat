"use strict";springChatServices.factory("RoomsFactory",["$injector","$route","$routeParams","$http","$location","$interval","$cookies","$timeout","toaster","ChatSocket","$cookieStore","$q","$sce","$rootScope","ChannelFactory",function(o,e,t,r,n,s,a,i,c,u,m,f,d,l,g){function p(o){return null!=o&&1===o.type}function h(o){return null!=o&&2===o.type}function v(o){console.log("goToRoomEvn("+o+")"),void 0!=x&&(to(-x.nums),x.nums=0),x={roomId:o},V();var e=f.defer(),t=getRoomById(k,o);return void 0==t?(e.reject(),e.promise):(x=t,g.isSocketSupport()===!0?(u.send("/app/chat.go.to.dialog/{0}".format(x.roomId),{},JSON.stringify({})),e.resolve(),e.promise):r.post(serverPrefix+"/chat.go.to.dialog/{0}".format(x.roomId)))}function I(o){if(null==o)return null;var e=!1;if(L=o,D.length>0){var t=differenceInSecondsBetweenDates(new Date(o.date),new Date(D[0].date))<j;D[0].username==o.username?(t&&0==o.attachedFiles.length&&(e=!0,D[0].message=o.message+"\n\n"+D[0].message),o.position=D[0].position):o.position=!D[0].position}else o.position=!1;0==e&&D.unshift(o),l.$$postDigest(function(){var o=document.getElementById("messagesScroll");o.scrollTop=99999999999})}function y(o){if(null==o)return null;var e=document.getElementById("messagesScroll"),t=Math.round(e.scrollTop+e.clientHeight)>=e.scrollHeight-100;if(D.length>0?D[D.length-1].username==o.username?o.position=D[D.length-1].position:o.position=!D[D.length-1].position:o.position=!1,D.length>0){var r=differenceInSecondsBetweenDates(new Date(o.date),new Date(D[D.length-1].date))<j;r&&D[D.length-1].username==o.username&&0==o.attachedFiles.length&&0==D[D.length-1].attachedFiles.length?(D[D.length-1].date=o.date,D[D.length-1].message+="\n\n"+o.message):D.push(o)}else D.push(o);l.$$postDigest(function(){var o=document.getElementById("messagesScroll");t&&(o.scrollTop=99999999999)})}function R(o){return null==x?void console.warn("loadMessagesContains failed duing to current room is not selected"):void r.post(serverPrefix+"/chat/room/{0}/get_messages_contains".format(x.roomId),o).success(function(o,e,t,r){S(o)}).error(function(o,e,t,r){})}function S(o){L=o[o.length-1];for(var e=0;e<o.length;e++)o[e].hasOwnProperty("message")&&I(o[e])}function b(){D=[],A()}function P(o){if(F=o.type,N=o.participants,"undefined"!=typeof o.messages){l.$broadcast("MessageBusyEvent",!0),L=o.messages[o.messages.length-1];for(var e=0;e<o.messages.length;e++)I(o.messages[e])}var t=JSON.parse(o.bot_param);if(t.length>0)for(var r in t)botParameters[t[r].name]=JSON.parse(t[r].value);i(function(){var o=document.getElementById("messagesScroll");o.scrollTop=o.scrollHeight,l.$broadcast("MessageBusyEvent",!1)},0,!1)}function T(){r.post(serverPrefix+"/{0}/chat/participants_and_messages".format(x.roomId),{}).success(function(o,e,t,r){P(o)}).error(function(o,e,t,r){})}function O(){if(console.log("try "+x),1==g.getIsInited()){var o=getRoomById(k,t.roomId);if(null!=o&&h(o))return void r.post(serverPrefix+"/chat/consultation/fromRoom/"+o.roomId).success(function(o,e,t,r){""==o||void 0==o?l.goToAuthorize():n.path("consultation_view/"+o)}).error(function(o,e,t,r){l.goToAuthorize()});if(null==t.roomId)return;z(t.roomId).then(function(o){void 0!=o&&null!=o&&(x=o.data)},function(){l.goToAuthorize(),c.pop("warning",w,B,5e3)}),r.post(serverPrefix+"/bot_operations/tenant/did_am_wait_tenant/{0}".format(x.roomId)).success(function(o,e,t,r){1==o&&showToasterWaitFreeTenant()}).error(function(o,e,t,r){alert("did_am_wait_tenant: server error")})}}function E(){console.log("roomsUpdateLP()"),r.post(serverPrefix+"/chat/rooms/user/login").success(function(o,e,t,r){console.log("roomsUpdateLP data:"+o),Z(o),E()}).error(function(o,e,t,r){E()})}function _(o){l.hideMenu(),r.post(serverPrefix+"/chat/rooms/private/"+o).success(function(o,e,t,r){console.log("PRIVATE ROOM CREATE OK "),null==ro.getCurrentRoom()&&(x={}),null!=o&&void 0!=o?g.changeLocation("/dialog_view/"+o):oo()}).error(oo)}function A(){L=null}var C=o.get("UserFactory"),M=function(o,e){r.post(serverPrefix+"/chat/rooms/add?name="+encodeURIComponent(o),e).success(function(o,e,t,r){console.log("ADD USER OK "+o)}).error(function(o,e,t,r){c.pop("error","Error","server request timeout",1e3)})},w="Сталася помилка",B="Кімната не існує або Ви не є її учасником",U=[],x=null,D=[],N=[],F=-1,J=[];l.message_busy=!0;var L,k=[],z=function(o){void 0!==x&&void 0!==getRoomById(k,x)&&(getRoomById(k,x.roomId).date=curentDateInJavaFromat());var e=v(o);return e},j=10,V=function(){D=[],l.$broadcast("MessageBusyEvent",!1),l.$broadcast("RoomChanged",!1),console.log("roomId:"+x.roomId),g.isSocketSupport()===!0?(U.push(u.subscribe("/topic/{0}/chat.message".format(x.roomId),function(o){y(JSON.parse(o.body))})),U.push(u.subscribe("/app/{0}/chat.participants/{1}".format(x.roomId,globalConfig.lang),function(o){if("{}"==o.body)return void l.goToAuthorize();var e=JSON.parse(o.body);P(e)})),U.push(u.subscribe("/topic/{0}/chat.participants".format(x.roomId,globalConfig.lang),function(o){var e=JSON.parse(o.body);N=e.participants}))):(Y(),W(),T()),U.push(u.subscribe("/topic/{0}/chat.typing".format(x.roomId),function(o){var e=JSON.parse(o.body);if(e.username!=C.getChatUserId())for(var t in N){var r=N[t];r.getChatUserId==e.username&&(N[t].typing=e.typing)}}))},H=function(o){r.post(serverPrefix+"/bot_operations/tenant/{0}/askToAddToRoom/{1}".format(o,x.roomId),{}).success(function(o,e,t,r){userAddedToRoom=!0}).error(function(o,e,t,r){userAddedToRoom=!0})},q=function(o){r.post(serverPrefix+"/chat/rooms.{0}/user/add?chatId={1}".format(x.roomId,o),{}).success(function(o,e,t,r){}).error(function(o,e,t,r){})},K=function(o){r.post(serverPrefix+"/chat/rooms.{0}/user.remove/{1}".format(x.roomId,o),{}).success(function(o,e,t,r){if(0==o)return void c.pop("error","Error","Cant remove user from the room",1e3)}).error(function(o,e,t,r){c.pop("error","Error","Cant remove user from the room",1e3)})},Y=function o(){var e=serverPrefix+"/{0}/chat/message/update".format(x.roomId);J.push($.ajax({type:"POST",mimeType:"text/html; charset=UTF-8",url:e,success:function(e){for(var t=JSON.parse(e),r=0;r<t.length;r++)t[r].hasOwnProperty("message")&&y(t[r]);o()},error:function(e,t,r){0!==e.status&&0!==e.readyState&&(404!==e.status&&405!==e.status||(g.changeLocation("/chatrooms"),c.pop("warning",w,B,5e3)),o())}}))},W=function o(){var e=serverPrefix+"/{0}/chat/participants/update".format(x.roomId);J.push($.ajax({type:"POST",url:e,mimeType:"text/html; charset=UTF-8",success:function(e){o();var t=JSON.parse(e);t.hasOwnProperty("participants")&&(N=t.participants)},error:function(o,e,t){0!==o.status&&0!==o.readyState&&(404!==o.status&&405!==o.status||(g.changeLocation("/chatrooms"),c.pop("warning",w,B,5e3)))}}))},G=function(o){if(void 0==x)return!1;var e=USER_COPABILITIES_BY_ROOM.ADD_USER|USER_COPABILITIES_BY_ROOM.REMOVE_USER,t=o==x.roomAuthorId;if(t=t||(x.userPermissions&e)==e,"undefined"==typeof x)return!1;var r=x.active&&t&&l.isMyRoom&&l.authorize;return r},Q=function(){if(void 0==x)return!1;if("undefined"==typeof x)return!1;var o=x.active&&l.isMyRoom&&l.authorize;return o},X=function(o){var e=void 0==U||0==U.length;if(!e)for(;U.length>0;){var t=U.pop();t.unsubscribe()}for(;J.length>0;){var t=J.pop();t.abort()}};g.setIsInitedCallback(O);var Z=function(o){var e;e=g.isSocketSupport()===!0?JSON.parse(o.body):o;var t=e.replace,r=e.list;if(t)k=r;else for(var n=0;n<k.length;n++)for(var s=r.length-1;s>=0;s--)r[s].roomId==k[n].roomId&&(k[n]=r[s],r.splice(s,1));null!=x&&(x=getRoomById(k,x.roomId)),to()},oo=function(o,e,t,r){c.pop("error","PRIVATE ROOM CREATE FAILD","",3e3),console.log("PRIVATE ROOM CREATE FAILD "),l.goToAuthorize(function(){changeLocation("/chatrooms")})},eo=0,to=function(o){if(void 0!=o)return void(eo+=o);eo=0;for(var e=0;e<k.length;e++)eo+=k[e].nums},ro={goToRoom:z,unsubscribeCurrentRoom:X,updateRooms:Z,getCurrentRoom:function(){return x},setRooms:function(o){k=o,to()},getRooms:function(){return k},getMessages:function(){return D},getParticipants:function(){return N},getOldMessage:function(){return L},updateNewMsgNumber:to,getNewMsgNumber:function(){return eo},calcPositionUnshift:I,checkUserAdditionPermission:G,removeUserFromRoom:K,subscribeRoomsUpdateLP:E,clearMessages:b,loadMessagesContains:R,goToPrivateDialog:_,addDialog:M,isRoomPrivate:p,isRoomConsultation:h,addTenantToRoom:H,addUserToRoom:q,checkMessageAdditionPermission:Q};return ro}]);