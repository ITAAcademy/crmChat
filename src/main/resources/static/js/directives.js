"use strict";function starRating(){return{restrict:"EA",template:'<ul class="star-rating" ng-class="{readonly: readonly}">  <li ng-repeat="star in stars" class="star" ng-class="{filled: star.filled}" ng-click="toggle($index)">    <i class="fa fa-star"></i>  </li></ul>',scope:{ratingValue:"=ngModel",max:"=?",onRatingSelect:"&?",readonly:"=?"},link:function(e,t,n){function o(){e.stars=[];for(var t=0;t<e.max;t++)e.stars.push({filled:t<e.ratingValue})}"angular.noop"==n.onratingselect&&(n.onratingselect=function(){}),void 0==e.max&&(e.max=5),e.toggle=function(t){void 0!=e.readonly&&e.readonly!==!1||(e.ratingValue=t+1,n.onratingselect({rating:t+1}),o())},e.ratingValue=0,o()}}}function updateModelGet(e,t,n){e({method:"GET",url:t}).then(n,function(e){console.log("updateModelGet():requestUrl:"+t+" failed")})}function initFolded(e,t){e.scroll,e.folded=!0,e.toggleFolded=function(t){void 0!=t&&$(t.target).hasClass("block_controll")||(e.folded=!e.folded,e.scroll.overflowy=!e.folded,e.folded&&e.scroll.scrollTop(e.scroll.scrollTop()))},e.scroll=$($(t).find(".scroll")),e.scroll.overflowy=!e.folded}function studentsBlock(e,t,n,o){return{restrict:"EA",scope:{},templateUrl:"static_templates/students_block.html",link:function(t,r,i){function a(){updateModelGet(e,"chat/get_students/",function(e){t.students=e.data})}a(),initFolded(t,r),t.isUserOnline=o.isUserOnline,t.blockName="Студенти",t.goToPrivateDialog=n.goToPrivateDialog,t.participantsSort=o.participantsSort}}}function trainersBlock(e,t,n,o){return{restrict:"EA",scope:{},templateUrl:"static_templates/trainers_block.html",link:function(e,t,r){e.students=o.getStudentTrainerList,initFolded(e,t),e.isUserOnline=o.isUserOnline,e.blockName="Тренер",e.goToPrivateDialog=n.goToPrivateDialog,e.participantsSort=o.participantsSort}}}function participantsBlock(e,t,n,o){return{restrict:"EA",scope:{},templateUrl:"static_templates/participants_block.html",link:function(e,t,r){e.participants=n.getParticipants,e.blockName="Учасники розмови",e.currentRoom=n.getCurrentRoom,e.hideEmpty=!1,e.getChatUserId=o.getChatUserId,e.participantsSort=o.participantsSort,e.checkUserAdditionPermission=function(){return n.checkUserAdditionPermission(o.getChatUserId())},e.isUserOnline=o.isUserOnline,e.removeUserFromRoom=n.removeUserFromRoom;var i=!1;e.toggleNewUser=function(){return i=!i,i?e.$root.$emit("rootScope:roomsBlockModeChange",2):e.$root.$emit("rootScope:roomsBlockModeChange",1),i},initFolded(e,t)}}}function messagesBlock(e,t){return{restrict:"EA",templateUrl:"static_templates/messages_block.html",link:function(e,n,o){e.messages=t.getMessages;$(".scroll")}}}function messageInput(e,t,n,o,r,i){return{restrict:"EA",templateUrl:"static_templates/message_input.html",link:function(a,s,l){a.sendMessage=function(s,l,c){var d=null==c||c===!0;if(r.isMessageSended()){var g;if(g="undefined"==typeof s?a.newMessage:s,!("undefined"==typeof g||g.length<1)){d&&(a.newMessage="",a.files=[]);var u="/app/{0}/chat.message".format(t.getCurrentRoom().roomId);r.setMessageSended(!1),null==l&&(l=[]);var p={message:g,username:r.getChatUserNickname(),attachedFiles:l,chatUserAvatar:r.getChatuserAvatar()};if(1==i.isSocketSupport()){n.send(u,{},JSON.stringify(p));var m=function(){angular.isDefined(sendingMessage)&&(o.cancel(sendingMessage),sendingMessage=void 0),r.isMessageSended()||(a.messageError(),r.setMessageSended(!0))};sendingMessage=o(m,2e3)}else e.post(serverPrefix+"/{0}/chat/message".format(t.getCurrentRoom().roomId),p).success(function(e,t,n,o){console.log("MESSAGE SEND OK "+e),r.setMessageSended(!0)}).error(function(e,t,n,o){a.messageError(),r.setMessageSended(!0)});void 0===s&&(a.newMessage="")}}},a.clearFiles=function(){a.files=[]},a.selectFiles=function(e){a.files=e},a.getNamesFromFiles=function(e){if(null==e)return null;for(var t=[],n=0;n<e.length;n++)t.push(e[n].name);return t},a.sendMessageAndFiles=function(){var e=a.files,n=null==a.newMessage||a.newMessage.length<1?" ":a.newMessage;return null!=e&&e.length>0?uploadXhr(e,"upload_file/"+t.getCurrentRoom().roomId,function(e){a.uploadProgress=0,a.sendMessage(n,JSON.parse(e),!0),a.$apply()},function(e){a.uploadProgress=0,a.$apply(),alert("SEND FAILED:"+JSON.parse(e.response).message)},function(e,t){console.log(e.loaded+" / "+e.totalSize),a.uploadProgress=Math.floor(e.loaded/e.totalSize*100),a.$apply()}):a.sendMessage(n,void 0,!0),!1}}}}function roomsBlockMini(e,t,n,o){return{restrict:"EA",templateUrl:"static_templates/rooms_block_mini.html",link:function(r,i,a){roomsBlockLinkFunction(r,i,a,e,t,n,o)}}}function roomsBlock(e,t,n,o,r){return{restrict:"EA",templateUrl:"static_templates/rooms_block.html",link:function(i,a,s){roomsBlockLinkFunction(i,a,s,e,t,n,o),i.roomsListSearched=[],i.isUserOnline=o.isUserOnline,i.getRooms=t.getRooms,i.participantsSort=o.participantsSort,i.updateChatUsersByEmail=function(t,n){return r.cancel(i.updatingUsersByEmailPromise),null==t||t.length<1?(i.updatingUsersByEmailPromise=void 0,void(i.roomsListSearched=[])):void(i.updatingUsersByEmailPromise=r(function(){var n=serverPrefix+"/get_users_log_events_like?login="+t;return e.get(n,{}).success(function(e){i.roomsListSearched=e})},n))}}}}function notificable(e,t,n){return{scope:{itemClick:"=itemclick",getData:"&data"},restrict:"EA",link:function(o,r,i){if(null==i.template)return void console.error("Template must be set");var a="static_templates/"+i.template+".html",s=t.getTrustedResourceUrl(a);e(s).then(function(e){var t=$("#"+i.container);o.$parent.toggleVisible=function(){t.toggleClass("shown")},n(t.html(e).contents())(o)},function(){})}}}function fileMiniature(e,t,n,o){return{restrict:"EA",templateUrl:"static_templates/file_miniature.html",link:function e(t,n,r){var i=["aac","ai",,"aiff","asp","avi","bmp","c","cpp","css","dat","dmg","doc","docx","dot","dotx","dwg","dxf","eps","exe","flv","gif","h","html","ics","iso","java","jpg","js","key","less","m4v","mid","mov","mp3","mp4","mpg","odp","ods","odt","otp","ots","ott","pdf","php","png","pps","ppt","psd","py","qt","rar","rb","rtf","sass","scss","sql","tga","tgz","tiff","txt","wav","xls","xlsx","xml","yml","zip"],a=function(e){return e.split(".").pop()},s=function(e){return i.indexOf(e)!=-1},l=function(e){var t="images/svg-file-icons/{0}.svg";return s(e)?t.format(e):t.format("nopreview")},e=o(r.link)(t),c="undefined"!=typeof r.nameonly&&"false"!=r.nameonly,d=c?e:t.getNameFromRandomizedUrl(e),g=a(d);t.fileName=d,c||(t.link=e),t.imageSrc=l(g)}}}function audioVideoRP(e,t){return{restrict:"EA",templateUrl:"static_templates/audio_video_player.html",link:function(e,t,n){function o(t){e.$apply(function(){e.stream=$sce.trustAsResourceUrl(URL.createObjectURL(t))});var n=new MediaStreamRecorder(t);n.mimeType="audio/webm",n.ondataavailable=function(e){URL.createObjectURL(e)},n.start(3e4)}function r(e){console.error("media error",e)}var i={audio:!0};navigator.getUserMedia(i,o,r)}}}var directivesModule=angular.module("springChat.directives",[]);directivesModule.directive("printMessage",function(){return{restrict:"A",template:'<span ng-show="message.priv">[private] </span><strong>{{message.username}}<span ng-show="message.to"> -> {{message.to}}</span>:</strong> {{message.message}}<br/>'}}),directivesModule.constant("mySettings",{baseUrl:globalConfig.baseUrl});var imageDrop=function(e,t){return{restrict:"A",link:function(n,o,r){var i=e(r.onImageDrop),a=function(e){e.preventDefault(),angular.element("body").addClass("dragOver")},s=function(e){e.preventDefault(),angular.element("body").removeClass("dragOver")},l=function(e){n.uploadedFiles=e,n.$apply(i(n))};t.bind("dragover",a),o.bind("dragleave",s).bind("drop",function(e){s(e),l(e.originalEvent.dataTransfer.files)})}}};angular.module("springChat.directives").directive("imagedrop",["$parse","$document",imageDrop]);var autoGrow=function(){return function(e,t,n){var o=t[0].offsetHeight,r=t.css("paddingLeft"),i=t.css("paddingRight"),a=angular.element("<div></div>").css({position:"absolute",top:-1e4,left:-1e4,width:t[0].offsetWidth-parseInt(r||0)-parseInt(i||0),fontSize:t.css("fontSize"),fontFamily:t.css("fontFamily"),lineHeight:t.css("lineHeight"),resize:"none"});angular.element(document.body).append(a);var s=function(){var e=function(e,t){for(var n=0,o="";n<t;n++)o+=e;return o},n=t.val().replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/&/g,"&amp;").replace(/\n$/,"<br/>&nbsp;").replace(/\n/g,"<br/>").replace(/\s{2,}/g,function(t){return e("&nbsp;",t.length-1)+" "});a.html(n),t.css("height",Math.max(a[0].offsetHeight+10,o)+"px")};t.bind("keyup keydown keypress change",s),s()}};angular.module("springChat.directives").directive("autoGrow",autoGrow);var dirFunc=function(e,t){return{restrict:"E",link:function(n,o,r){n.$watch(r.content,function(){if(o.html(t(r.content)(n)),"undefined"!=typeof r.callback){var i=new Function("return "+r.callback)();"undefined"!=typeof i&&i(o)}e(o.contents())(n)},!0)}}};angular.module("springChat.directives").directive("dir",["$compile","$parse",dirFunc]);var modaleToggle=function modaleToggle($compile,$parse,$rootScope){return{restrict:"EA",scope:{id:"=",callback:"&callback",ignoreId:"@ignoreId"},link:function link(scope,element,attr){void 0!=scope.id&&(void 0==$rootScope.__modaleToggle&&($rootScope.__modaleToggle=new Map),$rootScope.__modaleToggle[scope.id]={restart:function(){toggle=!1}});var toggle=!1,ignoredList=[];if("["==scope.ignoreId.trim()[0])try{ignoredList=eval(scope.ignoreId)}catch(e){ignoredList.push(scope.ignoreId)}else ignoredList.push(scope.ignoreId);null!=scope.callback&&$(window).click(function(e){if("none"!=e.target.style.pointerEvents){for(var t=!0,n=0;n<ignoredList.length;n++){var o=document.getElementById(ignoredList[n]);null!=o&&(t=t&&e.target!=o&&!o.contains(e.target))}(e.target===element[0]||element[0].contains(e.target)||toggle&&t)&&(e.preventDefault(),e.stopPropagation(),scope.$apply(function(){var e=scope.callback();toggle=void 0==e?!toggle:e}))}})}}};angular.module("springChat.directives").directive("modaleToggle",["$compile","$parse","$rootScope",modaleToggle]),angular.module("springChat.directives").directive("starRating",starRating);var tenantsBlock=function(e,t,n,o){return{restrict:"EA",scope:{},templateUrl:"static_templates/tenants_block.html",link:function(e,t,r){initFolded(e,t),e.isUserOnline=n.isUserOnline,e.getTenantsList=n.getTenantsList,e.addTenantToRoom=o.addTenantToRoom,e.blockName="Тенанти"}}};angular.module("springChat.directives").directive("tenantsBlock",["$http","mySettings","UserFactory","RoomsFactory",tenantsBlock]),angular.module("springChat.directives").directive("studentsBlock",["$http","mySettings","RoomsFactory","UserFactory",studentsBlock]),angular.module("springChat.directives").directive("trainersBlock",["$http","mySettings","RoomsFactory","UserFactory",trainersBlock]),angular.module("springChat.directives").directive("participantsBlock",["$http","mySettings","RoomsFactory","UserFactory",participantsBlock]),angular.module("springChat.directives").directive("messagesBlock",["$http","RoomsFactory",messagesBlock]),angular.module("springChat.directives").directive("messageInput",["$http","RoomsFactory","ChatSocket","$timeout","UserFactory","ChannelFactory",messageInput]),angular.module("springChat.directives").directive("emHeightSource",function(){return{scope:{callback:"&callback"},link:function(e,t,n){t.on("resize",function(){e.__height!=t.height()&&e.callback({oldSize:e.__height,newSize:t.height()}),e.__height=t.height()})}}}),angular.module("springChat.directives").directive("roomsBlockMini",["$http","RoomsFactory","ChannelFactory","UserFactory",roomsBlockMini]);var roomsBlockFilter=function(e){return function(e,t){if(e){var n=[];if("LastContacts"==t)return e;for(var o=0;o<e.length;o++)1==e[o].type&&n.push(e[o]);return n}}};angular.module("springChat.directives").directive("roomsBlock",["$http","RoomsFactory","ChannelFactory","UserFactory","$timeout",roomsBlock]).filter("roomsBlockFilter",["RoomsFactory",roomsBlockFilter]);var roomsBlockLinkFunction;angular.module("springChat.directives").directive("notificable","$templateRequest","$sce","$compile",notificable),roomsBlockLinkFunction=function(e,t,n,o,r,i,a){function s(e){r.addUserToRoom(e)}e.isRoomPrivate=r.isRoomPrivate;var l=[];e.isUserOnline=a.isUserOnline,e.rooms=r.getRooms,e.searchEnabled=!1,e.createEnabled=!1,e.getCurrentRoom=r.getCurrentRoom,e.tabState="Contacts",e.mode=1;var c;e.$on("$destroy",function(){c()}),c=e.$root.$on("rootScope:roomsBlockModeChange",function(t,n){switch(console.log(n),e.mode=n,e.mode){case 1:break;case 2:e.showContacts()}}),e.sortBy=["date","string"],e.displayLetters=!1,e.room_create_input="",e.isInterlocutorOnline=function(t){return!(null==t||null==t.privateUserIds||t.privateUserIds.length<1)&&(!(a.getChatUserId()==t.privateUserIds[0]||!e.isUserOnline(t.privateUserIds[0]))||!(a.getChatUserId()==t.privateUserIds[1]||!e.isUserOnline(t.privateUserIds[1])))},e.goToPrivateDialog=r.goToPrivateDialog,e.clickToRoomEvent=function(t){if(!e.searchEnabled&&!e.createEnabled){switch(e.mode){case 1:e.doGoToRoom(t.roomId);break;case 2:t.privateUserIds[0]==a.getChatUserId()&&s(t.privateUserIds[1]),t.privateUserIds[1]==a.getChatUserId()&&s(t.privateUserIds[0]),e.mode=1}e.$root.hideMenu()}},e.clickToUserEvent=function(t){switch(e.mode){case 1:e.onFriendClick(t);break;case 2:s(t.chatUserId),e.mode=1}e.$root.hideMenu()},e.toggleSearch=function(){return e.searchEnabled=!e.searchEnabled,e.searchEnabled},e.createNewRoom=function(t){return r.addDialog(e.room_create_input,l),e.$root.hideMenu(),!1},e.toggleCreate=function(){e.createEnabled=!e.createEnabled,0==e.createEnabled?(l=[],e.room_create_input=""):e.showContacts()},e.canBeRemoved=function(e){return 1!=e.type},e.showLastContacts=function(){2!=e.mode&&(e.tabState="LastContacts",e.sortBy=["-nums","-date"],e.displayLetters=!1)},e.showContacts=function(){e.tabState="Contacts",e.sortBy=["string"],e.displayLetters=!0},e.returnAvatar=function(e){return null==e.avatars?"noname.png":e.avatars.length>1?e.avatars[1]:e.avatars[0]},e.addForCreatRoom=function(e){1==e.type&&void 0!=e.privateUserIds&&(e.privateUserIds[0]==a.getChatUserId()&&l.push(e.privateUserIds[1]),e.privateUserIds[1]==a.getChatUserId()&&l.push(e.privateUserIds[0]))},e.doGoToRoom=function(t){e.searchEnabled||e.createEnabled||(e.loadOnlyFilesInfiniteScrollMode=!1,i.changeLocation("/dialog_view/"+t))};$(".scroll");e.showLastContacts()},angular.module("springChat.directives").directive("fileMiniature",["$http","RoomsFactory","ChannelFactory","$parse",fileMiniature]);var compilable=function(e,t){return{restrict:"E",link:function(n,o,r){n.$watch(r.content,function(){if(o.html(t(r.content)(n)),"undefined"!=typeof r.callback){var i=new Function("return "+r.callback)();"undefined"!=typeof i&&i(o)}e(o.contents())(n)},!0)}}};angular.module("springChat.directives").directive("compilable",["$compile","$parse",compilable]);var ngDraggable=function(e){return{restrict:"A",scope:{dragOptions:"=ngDraggable"},link:function(t,n,o){function r(e){v=e.clientY-l,f=e.clientX-s,a(),g&&g(e)}function i(t){e.unbind("mousemove",r),e.unbind("mouseup",i),d&&d(t)}function a(){var e=p[0].offsetWidth,t=p[0].offsetHeight;u&&(f<u.left?f=u.left:f>u.right-e&&(f=u.right-e),v<u.top?v=u.top:v>u.bottom-t&&(v=u.bottom-t)),p.css({top:v+"px",left:f+"px"})}var s,l,c,d,g,u,p,m,f=0,v=0;if(t.dragOptions){c=t.dragOptions.start,g=t.dragOptions.drag,d=t.dragOptions.stop;var h=t.dragOptions.container;h&&(u=document.getElementById(h).getBoundingClientRect(),m=angular.element(document.getElementById(h))),p=angular.element(document.getElementById(t.dragOptions.dragElement))}n.on("mousedown",function(t){return!(!$(p).hasClass("drag-disable")&&t.target==n[0])||(t.preventDefault(),s=t.clientX-p[0].offsetLeft,l=t.clientY-p[0].offsetTop,e.on("mousemove",r),e.on("mouseup",i),void(c&&c(t)))})}}};angular.module("springChat.directives").directive("ngDraggable",["$document",ngDraggable]),angular.module("springChat.directives").directive("checkbox",function(){return{restrict:"EA",require:"ngModel",replace:!0,template:'<a class="g-checkbox"><input id="{{id}}" type="checkbox" style="display: none" ng-checked="ngModel"/></a>',scope:{id:"@",ngModel:"=",ngChange:"&"},link:function(e,t,n){t.removeAttr("id"),t.bind("click",function(){t.toggleClass("checked"),e.ngModel=!e.ngModel,void 0!=e.ngChange&&e.ngChange(),e.$apply()})}}}),angular.module("springChat.directives").directive("audioVideoRP",["$http","RoomsFactory",audioVideoRP]);