"use strict";springChatControllers.controller("ChatViewBuilderController",["$routeParams","$rootScope","$scope","$window","$uibModal","$http","$location","$interval","$cookies","$timeout","toaster","ChatSocket","$cookieStore","Scopes","$q","$controller",function(e,o,t,a,i,n,r,l,s,c,d,g,u,m,b,f){function p(){t.activeToolsTab=2}function v(){t.activeToolsTab=1}function _(e){var o=e||"_",a=serverPrefix+"/bot_operations/get_five_categories_names_like/{0}".format(o);return n.get(a,{}).success(function(e){t.categoriesNamesList=e,console.log("get_categories_by_name:"+e)}).error(function(e,o,t,a){})}function D(e,o){var a=(name||"_",serverPrefix+"/bot_operations/get_five_dialog_items_description_where_description_like/{0}/{1}".format(e,o));return n.get(a,{}).success(function(e){t.dialogItemsDescriptionsList=e,console.log("dialogItemsDescriptionsList:"+e)}).error(function(e,o,t,a){})}function I(e){t.loadDialogItemsByDescription(e).success(function(){if(t.botDialogItemsForModal.length>0){var e=t.botDialogItemsForModal[0];t.selectedBotDialogItemForModal=e,t.dialogElementInputModel=e}})}function M(){t.loadCategoriesByName().success(function(){if(t.botCategoriesForModal.length>0){var e=t.botCategoriesForModal[0];t.selectedBotCategoryForModal=e,t.categoryInputModel=e,I(e.id)}})}function T(){var e,o=s.get("save_object");if(null!=o&&void 0!=o&&(e=JSON.parse(s.get("save_object"))),null!=e&&void 0!=e)for(var t in e)E(e[t],null,null,null,null)}function C(e){t.viewTabs.splice(e,1)}t.controllerName="ChatViewBuilderController";m.get("ChatController"),m.get("ChatRouteInterface");t.BUILDER=BOT_ELEMENTS_MODULE,t.toolsList=[];for(var w in BOT_ELEMENTS_MODULE.ElementTypes){var y=BOT_ELEMENTS_MODULE.ElementInstance(BOT_ELEMENTS_MODULE.ElementTypes[w]);t.toolsList.push(y)}t.$root.elementsListForLink=[],t.getElementsListForLink=function(e){return t.$root.elementsListForLink[e]},t.selected={properties:{vasia:!0,petia:"sdfdsgfd",salsa:12,mass:[1,2,5]}},t.$root.models={selected:null},t.$root.$watch("models.selected",function(){p()}),t.activeToolsTab=1,t.activeViewTab=0,t.$watch("activeViewTab",function(){t.updateView()}),t.containerTemplate=BOT_ELEMENTS_MODULE.ElementInstance("bot-container"),t.containerTemplate.parent=t.containerTemplate;var h=BOT_ELEMENTS_MODULE.ElementInstance("botsubmit");h.parent=t.containerTemplate,t.containerTemplate.childrens.push(h),t.viewTabs=[],t.langForRender=[],t.tabsChanges=[],t.DialogItemInputMode="auto";var F=function(){return{body:"",category:{id:1,name:null},description:"",testCase:"",idObject:{id:null,lang:null}}};t.updateLoadButton=function(){"auto"===t.DialogItemInputMode&&null!=t.selectedBotDialogItemForModal?t.isLoadButtonDisabled=!1:t.isLoadButtonDisabled=!0,"manual"===t.DialogItemInputMode&&(null!=t.selectedBotDialogItemForModalIdManually?t.isLoadButtonDisabled=!1:t.isLoadButtonDisabled=!0)},t.newDialogItem=F(),t.updateView=function(){if(0==t.activeViewTab||null===t.activeViewTab)return void console.log("ignore activeViewTab == 0");console.log("updateView"),t.$root.elementsListForLink=[],t.$root.models.selected=null,t.viewTabs[t.activeViewTab-1].content[t.langForRender[t.activeViewTab-1]]=null,t.viewTabs[t.activeViewTab-1].content[t.langForRender[t.activeViewTab-1]]=t.viewTabs[t.activeViewTab-1].objects[t.langForRender[t.activeViewTab-1]].getHTML(t.$root,!1),t.viewTabs[t.activeViewTab-1].items[t.langForRender[t.activeViewTab-1]].body="";for(var e=0;e<t.viewTabs[t.activeViewTab-1].objects[t.langForRender[t.activeViewTab-1]].childrens.length;e++)t.viewTabs[t.activeViewTab-1].items[t.langForRender[t.activeViewTab-1]].body+="\n"+t.viewTabs[t.activeViewTab-1].objects[t.langForRender[t.activeViewTab-1]].childrens[e].getHTML(t.$root,!0);t.tabsChanges[t.viewTabs.length-1]=!0;$(".editor-panel-right-scroll").niceScroll(),$("textarea").niceScroll()},t.isColor=function(e){if("textcolor"==e)return!0},t.$watch("dropCallback",function(){t.$root.dropCallback=t.dropCallback}),t.$watch("dragoverCallback",function(){t.$root.dragoverCallback=t.dragoverCallback}),t.$watch("deleteCallback",function(){t.$root.deleteCallback=t.deleteCallback}),t.$watch("dragStart",function(){t.$root.dragStart=t.dragStart}),t.dropCallback=function(e,o,a,i,n,r){if(null!=a.parent)for(var l=0;l<a.parent.childrens.length;l++)if(a.parent.childrens[l]==a){a.parent.childrens.splice(l,1);break}a.parent=r,r.childrens.splice(o,0,a),t.$apply(function(){t.updateView()})},t.deleteCallback=function(e,o,a,i,n,r){if(null!=a.parent)for(var l=0;l<a.parent.childrens.length;l++)if(a.parent.childrens[l]==a){a.parent.childrens.splice(l,1);break}t.$apply(function(){t.updateView()}),t.$$postDigest(function(){v()})},t.$root.dragoverCallback="",t.dragoverCallback=function(e,o,t,a,i){return!0},t.dragStart=function(e){t.$$postDigest(function(){v()})};var E=function(e,o,a,i){console.log("Load view: "+e);var n={title:"â„–"+e.en.idObject.id,content:new Map,objects:new Map,items:e};for(var r in n.items)n.objects[r]=BOT_ELEMENTS_MODULE.convertTextToElementInstance(n.items[r].body);t.viewTabs.push(n),t.langForRender[t.viewTabs.length-1]="ua",t.tabsChanges[t.viewTabs.length-1]=!1,t.$$postDigest(function(){t.activeViewTab=t.viewTabs.length})};t.updateViewByLang=function(){console.log("Update view by lang: ");var e=t.viewTabs[t.activeViewTab-1],o=t.langForRender[t.activeViewTab-1];e.objects[o]=BOT_ELEMENTS_MODULE.convertTextToElementInstance(e.items[o].body),t.updateView()},t.createBotDialogItem=function(e,o){var a=serverPrefix+"/bot_operations/create_bot_dialog_item";t.newDialogItem.description=e,t.newDialogItem.category.id=o,n.post(a,t.newDialogItem).success(function(e,o,a,i){E(e,o,a,i),t.newDialogItem=F(),d.pop("note","Created","dialogItem created",5e3)}).error(function(e,o,t,a){})},t.createNewCategory=function(e){var o=serverPrefix+"/bot_operations/create_category/"+e;n.get(o,{}).success(function(e,o,t,a){d.pop("note","Created","category created",5e3)}).error(function(e,o,t,a){})},t.loadBotDialogItem=function(){var e;"auto"==t.DialogItemInputMode&&null!=t.selectedBotDialogItemForModal?e=t.selectedBotDialogItemForModal.idObject.id:"manual"==t.DialogItemInputMode&&(e=t.selectedBotDialogItemForModalIdManually);var o=serverPrefix+"/bot_operations/get_bot_dialog_item/{0}".format(e);n.get(o,{}).success(E).error(function(e,o,t,a){})},t.selectedBotCategoryForModalChanged=function(e){if("undefined"!=typeof e){var o=t.botCategoriesForModal.reduce(function(e,o){return e[o.id]=o.name,e},{});I(e),console.log("selectedBotCategoryForModalChanged:"+e),t.categoryInputModel=o[e]}},t.initDialogItemModalLoader=function(){t.botDialogItemsForModal=[],t.botCategoriesForModal=[],t.selectedBotDialogItemForModal={},t.$watch("selectedBotDialogItemForModal",function(e,o){null!=e&&"undefined"!=typeof e&&null!=e.idObject&&"undefined"!=typeof e.idObject?t.selectedBotDialogItemForModalChanged(e.idObject.id):t.selectedBotDialogItemForModalChanged("")}),t.selectedBotCategoryForModal={},t.botDialogItemsIdsForModal=[],t.botCategoriesIdsForModal=[],t.selectedBotDialogItemForModal,t.selectedBotCategoryForModal,t.allCategories=[],t.categoryTemp=null,t.categoryInputModel=[],t.dialogElementInputModel=[]},t.initDialogItemModalLoader(),t.loadCategoriesIds=function(){var e=serverPrefix+"/bot_operations/get_all_categories_ids";return n.get(e,{}).success(function(e){t.botCategoriesIdsForModal=e,console.log("get_dialog_items_ids:"+e)}).error(function(e,o,t,a){})};var B=function(){var e=serverPrefix+"/bot_operations/get_all_category";return n.get(e,{}).success(function(e){t.allCategories=e}).error(function(e,o,t,a){})},L=function(e){var o=serverPrefix+"/bot_operations/get_categories_ids_where_names_like/"+e;return n.get(o,{}).success(function(e){t.botCategoriesIdsForModal=e,console.log("get_dialog_items_ids:"+e)}).error(function(e,o,t,a){})},V=function(e,o){var a=serverPrefix+"/bot_operations/get_dialog_items_ids_where_description_like/"+e+"/"+o;return n.get(a,{}).success(function(e){t.botDialogItemsIdsForModal=e,console.log("get_dialog_items_ids:"+e)}).error(function(e,o,t,a){})};t.reloadCategoriesByName=function(e){L(e).success(function(){t.botCategoriesIdsForModal.length>0&&(t.selectedBotCategoryForModal=t.botCategoriesIdsForModal[0])})},t.reloadDialogItemsByDescription=function(e,o){V(e,o).success(function(){t.botDialogItemsIdsForModal.length>0&&(t.selectedBotDialogItemForModal=t.botDialogItemsIdsForModal[0])})},t.loadDialogItemsIds=function(e){var o=serverPrefix+"/bot_operations/get_dialog_items_ids/{0}".format(e);return n({method:"GET",url:o}).success(function(e){t.botDialogItemsIdsForModal=e,console.log("get_dialog_items_ids:"+e)}).error(function(e,o,t,a){})},t.categoriesNamesList=[],t.dialogItemsDescriptionsList=[],t.reloadCategoriesNames=function(){c.cancel(t.reloadingCategoriesNamesPromise),t.reloadingCategoriesNamesPromise=c(function(){_(t.categoryNameToLoad)},200)},t.reloadDialogItemsDescriptions=function(){c.cancel(t.reloadDialogItemsDescriptionsPromise),t.reloadDialogItemsDescriptionsPromise=c(function(){D(t.selectedBotCategoryForModal,t.dialogItemDescriptionToLoad)},200)},t.loadCategoriesByName=function(e){e=e||"_";var o=serverPrefix+"/bot_operations/get_bot_category_names_having_string_first5/"+encodeURIComponent(e);return n.get(o,{}).success(function(e){t.botCategoriesForModal=e,console.log("get_dialog_items_ids:"+e)}).error(function(e,o,t,a){})},t.loadDialogItemsByDescription=function(e,o){o=o||"",e=e||"0";var a=serverPrefix+"/bot_operations/get_bot_dialog_items_descriptions_having_string_first5/"+e+"/"+encodeURIComponent(o);return n.get(a,{}).success(function(e){t.botDialogItemsForModal=e,console.log("get_dialog_items_ids:"+e)}).error(function(e,o,t,a){})},t.reloadCategories=function(){c.cancel(t.reloadingCategoriesPromise),t.reloadingCategoriesPromise=c(function(){t.loadCategoriesByName(t.categoryInputModel)},200)},t.isLoadButtonDisabled=!0,t.selectedBotDialogItemForModalChanged=function(e){if("undefined"!=typeof e){var o=t.botDialogItemsForModal.reduce(function(e,o){return e[o.idObject.id]=o.description,e},{});t.dialogElementInputModel=o[e],t.updateLoadButton()}},t.reloadDialogItems=function(e){"undefined"!=typeof e&&(c.cancel(t.reloadDialogItemsPromise),t.reloadDialogItemsPromise=c(function(){t.loadDialogItemsByDescription(e,t.dialogElementInputModel)},200))},t.onCategoryInputSelect=function(e){t.categoryInputModel=e;for(var o=(t.botCategoriesForModal.reduce(function(e,o){return e[o.id]=o.name,e},{}),0);o<t.botCategoriesForModal.length;o++)if(t.botCategoriesForModal[o].name==e){t.selectedBotCategoryForModal=t.botCategoriesForModal[o],I(t.botCategoriesForModal[o].id);break}console.log(e)},t.onDialogItemInputSelect=function(e){t.dialogElementInputModel=e;for(var o=0;o<t.botDialogItemsForModal.length;o++)if(t.botDialogItemsForModal[o].description==e){t.selectedBotDialogItemForModal=t.botDialogItemsForModal[o];break}},M(),t.saveBotDialogItem=function(){t.updateView();var e=t.viewTabs[t.activeViewTab-1].items[t.langForRender[t.activeViewTab-1]],o=serverPrefix+"/bot_operations/save_dialog_item";n.post(o,e).success(function(e,o,a,i){t.tabsChanges[t.viewTabs.length-1]=!1,d.pop("note","Save "+t.langForRender[t.activeViewTab-1],"save complete",5e3)}).error(function(e,o,t,a){d.pop("error","Error","cant save",5e3)}),t.onExit()},t.setBotDialogItemAsDefault=function(e){var o=t.viewTabs[t.activeViewTab-1].items.ua.idObject.id,a=e.id,i=serverPrefix+"/bot_operations/set_item/{0}/as_default/{1}".format(o,a);n.get(i,e).success(function(e,o,t,a){}).error(function(e,o,t,a){})},t.loadDlgItemModalVisible=!1,t.toggleLoadDialogItemModal=function(){$("#dialog_item_modal_loader").modal("toggle"),t.loadDlgItemModalVisible=!t.loadDlgItemModalVisible},t.testElementModule=function(){var e=BOT_ELEMENTS_MODULE.convertTextToElementInstance('<botsubmit text="test" name="kurva"><botinput text="testIn1" name="in1"></botinput><botinput text="testIn2" name="in2"></botinput></botsubmit>');t.$evalAsync(function(){t.$root.elementsListForLink=[],t.viewTabs[t.activeViewTab-1].content=e.getHTML(t.$root,!1)}),console.log("zigzag test:"+JSON.stringify(e))},t.compareType=function(e,o,t){return BOT_ELEMENTS_MODULE.getBotElementPropertyType(e,o)==t},t.onExit=function(){var e=[];for(var o in t.viewTabs)e.push(t.viewTabs[o].items);var a=JSON.stringify(e);if(s.put("save_object",a),2*a.length>4e3)return"All your changes can not be stored in temporary storage. Some changes will be lost !!!?"},a.onbeforeunload=t.onExit,t.tryCloseTabDialog=null,t.tryCloseTabDialogOpen=function(e){var o=e-1;null!=e&&void 0!=e||(o=t.activeViewTab-1);var a=t.tabsChanges[o];a?(t.tryCloseTabDialog=i.open({animation:!0,scope:t,templateUrl:"close_tab.html",size:"md"}),t.tryCloseTabDialog.index=o):t.$$postDigest(function(){C(o)})},t.showSetDefaultDialog=function(){B(),t.setDefaultDialog=i.open({animation:!0,scope:t,templateUrl:"set_default.html",size:"md"})},t.showCreateItemDialog=function(){B(),t.createItemDialog=i.open({animation:!0,scope:t,templateUrl:"create_item_dialog.html",size:"md"})},t.showCreateCategoryDialog=function(){t.createCategoryDialog=i.open({animation:!0,scope:t,templateUrl:"create_category.html",size:"md"})},t.tryCloseTabDialogClose=function(e){t.tryCloseTabDialog.close(),1==e&&C(null==t.tryCloseTabDialog.index||void 0==t.tryCloseTabDialog.index?t.activeViewTab-1:t.tryCloseTabDialog.index),t.tryCloseTabDialog=null},t.open1=function(){t.popup1.opened=!0},t.popup1={},t.formats=["dd-MMMM-yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],t.format=t.formats[2],t.altInputFormats=["dd.MM.yyyy"],t.dateOptions={maxDate:new Date(2020,5,22),minDate:new Date(1900,1,1),startingDay:1},T(),t.$$postDigest(function(){v()})}]);